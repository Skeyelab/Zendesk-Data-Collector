<style>
  .dashboard-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 2rem;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
    background-color: #f5f5f5;
    min-height: 100vh;
  }
  
  .dashboard-header {
    margin-bottom: 2rem;
  }
  
  .dashboard-title {
    font-size: 2rem;
    font-weight: 700;
    color: #1a1a1a;
    margin: 0 0 0.5rem 0;
  }
  
  .dashboard-subtitle {
    color: #666;
    font-size: 1rem;
    margin: 0;
  }
  
  .metrics-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 1.5rem;
    margin-bottom: 2rem;
  }
  
  .metric-card {
    background: white;
    border-radius: 8px;
    padding: 1.5rem;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    transition: box-shadow 0.2s;
  }
  
  .metric-card:hover {
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
  }
  
  .metric-label {
    font-size: 0.875rem;
    font-weight: 500;
    color: #666;
    margin: 0 0 0.5rem 0;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }
  
  .metric-value {
    font-size: 2.5rem;
    font-weight: 700;
    color: #1a1a1a;
    margin: 0 0 0.5rem 0;
  }
  
  .metric-description {
    font-size: 0.75rem;
    color: #999;
    margin: 0;
  }
  
  .chart-card {
    background: white;
    border-radius: 8px;
    padding: 1.5rem;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
  }
  
  .chart-title {
    font-size: 1.25rem;
    font-weight: 600;
    color: #1a1a1a;
    margin: 0 0 1.5rem 0;
  }
  
  .filter-section {
    background: white;
    border-radius: 8px;
    padding: 1.5rem;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    margin-bottom: 2rem;
  }
  
  .filter-title {
    font-size: 1rem;
    font-weight: 600;
    color: #1a1a1a;
    margin: 0 0 1rem 0;
  }
  
  .filter-checkboxes {
    display: flex;
    flex-wrap: wrap;
    gap: 1rem;
  }
  
  .filter-checkbox-item {
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }
  
  .filter-checkbox-item input[type="checkbox"] {
    width: 18px;
    height: 18px;
    cursor: pointer;
  }
  
  .filter-checkbox-item label {
    font-size: 0.875rem;
    color: #333;
    cursor: pointer;
    user-select: none;
  }
  
  .filter-badge {
    display: inline-block;
    background: #e3f2fd;
    color: #1976d2;
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
    font-size: 0.75rem;
    font-weight: 500;
    margin-left: 0.5rem;
  }
  
  @media (max-width: 768px) {
    .dashboard-container {
      padding: 1rem;
    }
    
    .metrics-grid {
      grid-template-columns: 1fr;
    }
    
    .dashboard-title {
      font-size: 1.5rem;
    }
  }
</style>

<div class="dashboard-container">
  <div class="dashboard-header">
    <h1 class="dashboard-title">Zendesk Metrics</h1>
    <p class="dashboard-subtitle">Overview of Zendesk tickets and desks</p>
  </div>

  <div class="filter-section">
    <h3 class="filter-title">
      Filter by Status
      <% if @excluded_statuses.any? %>
        <span class="filter-badge"><%= @excluded_statuses.count %> excluded</span>
      <% end %>
    </h3>
    <div class="filter-checkboxes">
      <% %w[new open pending solved closed].each do |status| %>
        <div class="filter-checkbox-item">
          <input 
            type="checkbox" 
            id="filter_<%= status %>" 
            name="exclude_statuses[]" 
            value="<%= status %>"
            <%= 'checked' if @excluded_statuses.include?(status) %>
            onchange="updateFilters()"
          >
          <label for="filter_<%= status %>"><%= status.capitalize %></label>
        </div>
      <% end %>
    </div>
  </div>

  <div class="metrics-grid">
    <div class="metric-card">
      <h3 class="metric-label">Total Tickets</h3>
      <p class="metric-value"><%= number_with_delimiter(@total_tickets) %></p>
      <p class="metric-description">Total number of Zendesk tickets</p>
    </div>

    <div class="metric-card">
      <h3 class="metric-label">Active Desks</h3>
      <p class="metric-value"><%= @active_desks %></p>
      <p class="metric-description">Number of active Zendesk desks</p>
    </div>

    <div class="metric-card">
      <h3 class="metric-label">Avg Resolution Time</h3>
      <% if @has_resolution_data %>
        <p class="metric-value"><%= @avg_resolution_time_formatted %></p>
        <p class="metric-description">Average resolution time</p>
      <% else %>
        <p class="metric-value" style="color: #999;">N/A</p>
        <p class="metric-description">No resolution time data available</p>
      <% end %>
    </div>
  </div>

  <div class="charts-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 1.5rem;">
    <div class="chart-card">
      <h3 class="chart-title">Tickets by Status</h3>
      <% if @tickets_by_status.present? && @tickets_by_status.any? %>
        <%= pie_chart @tickets_by_status, height: "300px", library: { plugins: { legend: { position: "right" } } } %>
      <% else %>
        <p style="color: #999; text-align: center; padding: 2rem;">No ticket data available</p>
      <% end %>
    </div>

    <div class="chart-card">
      <h3 class="chart-title">Tickets by Priority</h3>
      <% if @tickets_by_priority.present? && @tickets_by_priority.any? %>
        <%= bar_chart @tickets_by_priority, height: "300px", library: { plugins: { legend: { display: false } } } %>
      <% else %>
        <p style="color: #999; text-align: center; padding: 2rem;">No priority data available</p>
      <% end %>
    </div>
  </div>

  <div class="chart-card" style="margin-top: 1.5rem;">
    <h3 class="chart-title">Tickets Over Time</h3>
    <% if @tickets_over_time.present? && @tickets_over_time.any? %>
      <%= line_chart @tickets_over_time, height: "300px", discrete: true, library: { plugins: { legend: { display: false }, tooltip: { mode: "index", intersect: false } }, scales: { x: { ticks: { maxRotation: 45, minRotation: 45, maxTicksLimit: 20 } } } } %>
    <% else %>
      <p style="color: #999; text-align: center; padding: 2rem;">No time series data available</p>
    <% end %>
  </div>
</div>

<script>
  function updateFilters() {
    const checkboxes = document.querySelectorAll('input[name="exclude_statuses[]"]');
    const excludedStatuses = Array.from(checkboxes)
      .filter(cb => cb.checked)
      .map(cb => cb.value);
    
    const url = new URL(window.location.href);
    const baseUrl = url.origin + url.pathname;
    
    // Build query string manually to handle array parameters correctly for Rails
    // Rails expects: exclude_statuses[]=value1&exclude_statuses[]=value2
    const params = [];
    excludedStatuses.forEach(status => {
      params.push('exclude_statuses[]=' + encodeURIComponent(status));
    });
    
    // Construct the full URL
    const newUrl = params.length > 0 
      ? baseUrl + '?' + params.join('&')
      : baseUrl;
    
    // Debug log (remove in production)
    console.log('Filtering with statuses:', excludedStatuses);
    console.log('Navigating to:', newUrl);
    
    window.location.href = newUrl;
  }
</script>
